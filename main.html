<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Crypa Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <!-- Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <!-- Face API.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --surface-color: #000000;
            --surface-light: #121212;
            --primary-color: #5b6bf2;
            --text-primary: #ffffff;
            --text-secondary: #a8a8a8;
            --border-color: #262626;
            --danger-color: #ed4956;
            --success-color: #22c55e;
            --verified-color: #3b82f6;
            --nav-height: 60px;
            --msg-sent-bg: #3797f0;
            --msg-received-bg: #262626;
        }
        body.light-mode {
            --bg-color: #ffffff;
            --surface-color: #ffffff;
            --surface-light: #efefef;
            --primary-color: #0095f6;
            --text-primary: #262626;
            --text-secondary: #8e8e8e;
            --border-color: #dbdbdb;
            --msg-sent-bg: #efefef; 
            /* Note: standard light msg usually grey, sent blue, adjusted for visibility */
            --msg-sent-bg: #3797f0;
            --msg-received-bg: #efefef;
        }
        /* Specific override for light mode sent text */
        body.light-mode .sent {
            color: white;
        }
        body.light-mode .received {
            color: black;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: "Inter", sans-serif;
        }
        body {
            font-family: "Inter", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0s, color 0.3s;
        }
        .hidden {
            display: none !important;
        }
        .scrollable {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .view-container {
            flex: 1;
            position: relative;
            width: 100%;
            height: calc(100vh - var(--nav-height));
            display: none;
            flex-direction: column;
        }
        .view-container.active {
            display: flex;
        }
        .app-header {
            height: 50px;
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            flex-shrink: 0;
            z-index: 10;
            width: 100%;
        }
        .header-title-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            height: 100%;
        }
        .app-title {
            font-size: 18px;
            font-weight: 700;
            font-family: "Inter", sans-serif;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            background-color: var(--surface-color);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 2000;
            transition: transform 0.3s;
        }
        body.chat-active .bottom-nav {
            transform: translateY(100%);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            width: 25%;
            height: 100%;
            transition: 0.1s;
            background: transparent;
            border: none;
        }
        .nav-item.active {
            color: var(--text-primary);
        }
        .nav-item i {
            font-size: 28px;
        }
        
        /* Chat List Styles */
        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: var(--bg-color);
            cursor: pointer;
            position: relative;
        }
        .chat-item:active {
            background: var(--surface-light);
        }
        .avatar-wrapper {
            position: relative;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            background: #262626;
            display: block;
            border: 1px solid var(--border-color);
        }
        .verified-badge {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            background: var(--verified-color);
            border: 2px solid var(--surface-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            z-index: 2;
        }
        .online-dot {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 14px;
            height: 14px;
            background: var(--success-color);
            border: 2px solid var(--surface-color);
            border-radius: 50%;
            z-index: 3;
        }
        .chat-info {
            flex: 1;
            overflow: hidden;
            min-width: 0;
        }
        .chat-name {
            font-weight: 500;
            font-size: 15px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
        }
        .chat-msg {
            color: var(--text-secondary);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Dropdowns */
        .chat-dots {
            color: var(--text-secondary);
            padding: 8px;
        }
        .dropdown-menu {
            position: absolute;
            right: 10px;
            top: 40px;
            background: var(--surface-light);
            border-radius: 6px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            z-index: 100;
            width: 160px; 
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .dropdown-item {
            padding: 12px;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dropdown-item:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Chat Room */
        #chat-room {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 100;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #chat-room.active {
            transform: translateX(0);
        }
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 2px; /* Tighter grouping */
        }
        .message-bubble {
            max-width: 75%;
            word-wrap: break-word;
            margin-bottom: 8px;
            position: relative;
            font-size: 15px;
            line-height: 1.4;
        }
        .received, .bot {
            align-self: flex-start;
            background: var(--msg-received-bg);
            color: var(--text-primary);
            border-radius: 22px;
            padding: 10px 16px;
        }
        .sent, .user {
            align-self: flex-end;
            background: var(--msg-sent-bg);
            color: white;
            border-radius: 22px;
            padding: 10px 16px;
        }
        .msg-img {
            max-width: 220px;
            border-radius: 16px;
            margin: -4px -8px; /* Offset padding */
            display: block;
        }
        .msg-meta {
            font-size: 10px;
            opacity: 0.6;
            text-align: right;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 3px;
        }

        /* Inputs */
        .input-bar {
            background: var(--surface-color);
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 9999;
        }
        .text-input {
            flex: 1;
            background: var(--surface-light);
            border: 1px solid var(--border-color);
            border-radius: 22px;
            padding: 10px 16px;
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
            resize: none;
            max-height: 100px;
            min-height: 44px;
            line-height: 22px;
        }
        .action-btn {
            width: 40px;
            height: 40px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: transparent;
            color: var(--text-primary);
        }
        .btn-send {
            color: var(--primary-color);
            font-weight: 600;
            width: auto;
            padding: 0 10px;
        }

        /* Post Card (Instagram Style) */
        .post-card {
            background: var(--surface-color);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .post-header {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            gap: 10px;
        }
        .post-content-text {
            padding: 0 12px 10px;
            font-size: 14px;
        }
        .post-content-img {
            width: 100%;
            height: auto;
            display: block;
            background: var(--surface-light);
            object-fit: cover;
        }
        .post-actions {
            display: flex;
            align-items: center;
            padding: 10px 12px 0;
            gap: 16px;
        }
        .post-actions i {
            font-size: 26px;
            cursor: pointer;
        }
        .post-likes {
            padding: 0 12px;
            margin-top: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        .post-caption {
            padding: 6px 12px 12px;
            font-size: 14px;
        }
        .post-caption .username {
            font-weight: 600;
            margin-right: 5px;
        }
        .view-all-comments {
            padding: 0 12px 12px;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal-overlay.open {
            display: flex;
        }
        .modal-content {
            background: var(--surface-light);
            width: 85%;
            max-width: 350px; 
            border-radius: 16px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            color: var(--text-primary);
        }
        .btn-primary {
            width: 100%;
            background: var(--primary-color);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .input-field {
            width: 100%;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            padding: 12px;
            border-radius: 8px;
            color: var(--text-primary);
            margin-bottom: 15px;
            outline: none;
        }

        /* Comments Modal */
        .comments-modal-list {
            max-height: 250px; /* Show approx 4 comments */
            overflow-y: auto;
            margin-bottom: 15px;
        }
        .comment-item {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            font-size: 14px;
        }
        .comment-user {
            font-weight: 600;
        }

        /* AI Messages */
        #ai-messages {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .ai-message b {
            font-weight: 700;
        }

        /* Money Post */
        .money-post-card {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 12px;
            margin: 10px 15px;
            padding: 30px;
            text-align: center;
            color: black;
            font-weight: bold;
        }
        .money-claim-btn {
            background: black;
            color: #FFD700;
            padding: 10px 20px;
            border-radius: 20px;
            border: none;
            margin-top: 15px;
            font-weight: 700;
            cursor: pointer;
        }

        /* Fab */
        .feed-fab {
            position: fixed;
            bottom: calc(var(--nav-height) + 20px);
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .fab-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>

    <!-- View: Chat (Home) -->
    <div id="view-chat" class="view-container active">
        <div class="app-header">
            <div class="app-title">Crypa Pro</div>
            <button class="action-btn" id="btn-new-chat"><i class="material-icons-round">add</i></button>
        </div>
        <div id="chat-list" class="scrollable"></div>
        
        <!-- Chat Room Overlay -->
        <div id="chat-room">
            <div class="app-header">
                <button class="action-btn" id="btn-back-chat"><i class="material-icons-round">arrow_back_ios</i></button>
                <div style="flex:1; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <img src="" id="curr-chat-avatar" class="chat-avatar" style="width:30px;height:30px;border:none;">
                    <div id="curr-chat-name" style="font-weight:600; font-size:16px;"></div>
                    <div id="curr-chat-badge" class="verified-badge hidden" style="position:static;"><i class="material-icons-round" style="font-size:10px">check</i></div>
                </div>
                <div style="width:40px"></div>
            </div>
            <div id="messages-area" class="messages-container"></div>
            
            <div class="input-bar" id="input-bar-wrapper">
                <button class="action-btn" id="btn-money-modal" style="color:#fbbf24"><i class="material-icons-round">monetization_on</i></button>
                <button class="action-btn" id="btn-attach"><i class="material-icons-round">image</i></button>
                <input type="file" id="file-input" accept="image/*" class="hidden" />
                <textarea id="msg-input" class="text-input" rows="1" placeholder="Message..."></textarea>
                <button class="action-btn btn-send" id="btn-send-msg">Send</button>
            </div>
        </div>
    </div>

    <!-- View: Feed -->
    <div id="view-feed" class="view-container">
        <div class="app-header">
            <button class="action-btn" id="btn-back-feed"><i class="material-icons-round">arrow_back_ios</i></button>
            <div class="header-title-center">
                <div class="app-title">Crypa Feed</div>
            </div>
            <button class="action-btn" id="btn-refresh-feed"><i class="material-icons-round">refresh</i></button>
        </div>
        <div id="feed-content" class="scrollable">
            <!-- Posts go here -->
        </div>
        <div class="feed-fab">
            <div class="fab-btn" id="btn-post-text"><i class="material-icons-round">title</i></div>
            <div class="fab-btn" id="btn-post-img"><i class="material-icons-round">add_photo_alternate</i></div>
            <div class="fab-btn" id="btn-post-money" style="background:#fbbf24; color:black"><i class="material-icons-round">attach_money</i></div>
        </div>
    </div>

    <!-- View: AI -->
    <div id="view-ai" class="view-container">
        <div class="app-header">
            <button class="action-btn" id="btn-back-ai"><i class="material-icons-round">arrow_back_ios</i></button>
            <div class="header-title-center">
                <div class="app-title">Crypa AI</div>
            </div>
            <button class="action-btn" id="btn-ai-clear"><i class="material-icons-round">cleaning_services</i></button>
        </div>
        <div id="ai-messages" class="scrollable"></div>
        <div class="input-bar">
            <textarea id="ai-input" class="text-input" rows="1" placeholder="Ask Gemini..."></textarea>
            <button class="action-btn btn-send" id="btn-ai-send">Send</button>
        </div>
    </div>

    <!-- View: Profile -->
    <div id="view-profile" class="view-container">
        <div class="app-header">
            <div class="header-title-center">
                <div class="app-title">Profile</div>
            </div>
            <button class="action-btn" id="btn-logout"><i class="material-icons-round">logout</i></button>
        </div>
        <div class="scrollable" style="padding: 20px">
            <div style="display:flex; align-items:center; margin-bottom:20px;">
                <div class="avatar-wrapper" style="margin-right: 20px;">
                    <img src="" id="p-avatar" class="chat-avatar" style="width: 80px; height: 80px" />
                    <div id="p-badge" class="verified-badge hidden" style="width:24px;height:24px;font-size:14px;border-width:3px;"><i class="material-icons-round">check</i></div>
                </div>
                <div>
                    <div id="p-username" style="font-size: 20px; font-weight: 700">User</div>
                    <button id="btn-edit-p" style="background:var(--surface-light); border:1px solid var(--border-color); padding:5px 10px; border-radius:4px; font-weight:600; font-size:12px; color:var(--text-primary); margin-top:5px;">Edit Profile</button>
                </div>
            </div>

            <div style="margin-bottom:20px;">
                <div style="font-size:14px; font-weight:600; margin-bottom:5px;">Wallet (ETH)</div>
                <div id="p-wallet-bal" style="font-size: 24px; font-weight: 700; margin-bottom: 5px;">0.0000 ETH</div>
                <div id="p-wallet-addr" style="font-size: 11px; opacity: 0.5; font-family: monospace; word-break: break-all; margin-bottom:10px;">0x...</div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-primary" id="p-receive" style="flex:1;">Receive</button>
                    <button class="btn-primary" id="p-withdraw" style="flex:1; background:var(--surface-light); color:var(--text-primary);">Send</button>
                </div>
            </div>

            <button id="btn-verify-account" class="btn-primary" style="background: transparent; border: 1px solid var(--verified-color); color: var(--verified-color); margin-bottom:20px;">Get Verified</button>
            
            <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 0; border-top:1px solid var(--border-color);">
                <span>Dark Mode</span>
                <input type="checkbox" id="theme-toggle">
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <div class="nav-item active" data-target="view-chat"><i class="material-icons-round">chat_bubble_outline</i></div>
        <div class="nav-item" data-target="view-feed"><i class="material-icons-round">explore</i></div>
        <div class="nav-item" data-target="view-ai"><i class="material-icons-round">smart_toy</i></div>
        <div class="nav-item" data-target="view-profile"><i class="material-icons-round">person_outline</i></div>
    </div>

    <!-- Hidden Inputs/Modals -->
    <div id="modal-new-chat" class="modal-overlay">
        <div class="modal-content">
            <h3>New Chat</h3>
            <input type="text" id="search-input" class="input-field" placeholder="Search user..." style="margin-top:15px;" />
            <div id="search-results" style="max-height:200px; overflow-y:auto;"></div>
            <button class="btn-primary" onclick="this.closest('.modal-overlay').classList.remove('open')" style="background:transparent; color:var(--text-secondary);">Cancel</button>
        </div>
    </div>

    <!-- Comment Modal -->
    <div id="modal-comments" class="modal-overlay">
        <div class="modal-content">
            <h3 style="text-align:center; border-bottom:1px solid var(--border-color); padding-bottom:10px; margin-bottom:10px;">Comments</h3>
            <div id="comments-list" class="comments-modal-list"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="comment-input" class="input-field" placeholder="Add a comment..." style="margin:0; flex:1;" />
                <button id="btn-submit-comment" style="border:none; background:transparent; color:var(--primary-color); font-weight:600;">Post</button>
            </div>
            <button onclick="document.getElementById('modal-comments').classList.remove('open')" style="position:absolute; top:15px; right:15px; background:none; border:none; color:var(--text-primary);"><i class="material-icons-round">close</i></button>
        </div>
    </div>

    <!-- Post Text Modal -->
    <div id="modal-post-text" class="modal-overlay">
        <div class="modal-content">
            <h3>Create Post</h3>
            <textarea id="post-text-content" class="input-field" rows="4" placeholder="What's on your mind?"></textarea>
            <button class="btn-primary" id="btn-submit-post-text">Share</button>
            <button class="btn-primary" onclick="this.closest('.modal-overlay').classList.remove('open')" style="background:transparent; color:var(--text-secondary);">Cancel</button>
        </div>
    </div>

    <!-- Post Image Modal -->
    <div id="modal-post-img" class="modal-overlay">
        <div class="modal-content">
            <h3>New Photo Post</h3>
            <input type="file" id="post-img-file" accept="image/*" class="input-field" />
            <div id="img-preview-container" class="hidden" style="margin-bottom:10px;"><img id="post-img-preview" style="width:100%; border-radius:8px;"></div>
            <input type="text" id="post-img-caption" class="input-field" placeholder="Write a caption..." />
            <button class="btn-primary" id="btn-submit-post-img">Share</button>
            <button class="btn-primary" onclick="this.closest('.modal-overlay').classList.remove('open')" style="background:transparent; color:var(--text-secondary);">Cancel</button>
        </div>
    </div>

    <!-- Post Money Modal -->
    <div id="modal-post-money" class="modal-overlay">
        <div class="modal-content">
            <h3>Crypto Giveaway</h3>
            <input type="number" id="post-money-amount" class="input-field" placeholder="Amount ETH" step="0.0001"/>
            <button class="btn-primary" id="btn-submit-post-money" style="background:#fbbf24; color:black">Drop Crypto</button>
            <button class="btn-primary" onclick="this.closest('.modal-overlay').classList.remove('open')" style="background:transparent; color:var(--text-secondary);">Cancel</button>
        </div>
    </div>

    <!-- Other Modals (Edit Profile, etc) can be reused from previous but simplified here for brevity -->
    <div id="modal-edit-profile" class="modal-overlay">
        <div class="modal-content">
            <h3>Edit Profile</h3>
            <input type="file" id="avatar-input" accept="image/*" class="input-field" style="margin-top:10px" />
            <input type="text" id="edit-p-name" class="input-field" placeholder="Username" />
            <button class="btn-primary" id="btn-save-profile">Save</button>
            <button class="btn-primary" onclick="this.closest('.modal-overlay').classList.remove('open')" style="background:transparent; color:var(--text-secondary);">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, remove, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAy3uUW0adMIMfPVRZXZkOHipi3y1v7gs",
            authDomain: "crypa-f60b0.firebaseapp.com",
            databaseURL: "https://crypa-f60b0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "crypa-f60b0",
            storageBucket: "crypa-f60b0.firebasestorage.app",
            messagingSenderId: "504499957380",
            appId: "1:504499957380:web:0dd3cb2e0f9fd15a451cd1",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        let user = null;
        let chatId = null;
        let otherUid = null;
        let users = {};
        let wallet = {};
        let currentCommentPostId = null;

        // Gemini API Key (Base64 Encoded: AIzaSyD90JsW_Et1ejE20NfdvxXJLm1NBTc2GUk)
        const GEMINI_KEY_B64 = "QUl6YVN5RDkwSnNXX0V0MWVqRTIwTmZkdnhYSkxtMU5CVGMyR1Vr";
        
        // --- Navigation Logic ---
        function switchToHome() {
            document.querySelectorAll(".view-container").forEach(v => v.classList.remove("active"));
            document.getElementById("view-chat").classList.add("active");
            document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
            document.querySelector('.nav-item[data-target="view-chat"]').classList.add("active");
        }

        document.getElementById("btn-back-feed").onclick = switchToHome;
        document.getElementById("btn-back-ai").onclick = switchToHome;

        const navItems = document.querySelectorAll(".nav-item");
        navItems.forEach((n) => {
            n.onclick = () => {
                const target = n.dataset.target;
                navItems.forEach((i) => i.classList.remove("active"));
                n.classList.add("active");
                document.querySelectorAll(".view-container").forEach((v) => v.classList.remove("active"));
                document.getElementById(target).classList.add("active");
                if (target === 'view-feed') loadFeed();
            };
        });

        // --- Init ---
        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                init();
            } else {
                // Simplified Auth for Demo (Anonymous login if not verified)
               // window.location.href = "login.html"; // Assuming external login
               // For single file demo, create anonymous user if needed or redirect
               if(location.protocol !== 'file:') console.log("Please add login logic");
            }
        });

        async function init() {
            // Load User Data
            onValue(ref(db, `users/${user.uid}`), (s) => {
                if (s.exists()) {
                    const d = s.val();
                    users[user.uid] = d;
                    document.getElementById("p-username").innerText = d.username;
                    document.getElementById("p-avatar").src = d.avatar || `https://ui-avatars.com/api/?name=${d.username}`;
                    if(d.verified) document.getElementById("p-badge").classList.remove('hidden');
                }
            });

            // Load All Users (for cache)
            const uSnap = await get(ref(db, "users"));
            if (uSnap.exists()) users = { ...users, ...uSnap.val() };

            loadChats();
        }

        // --- Chat Logic ---
        function loadChats() {
            onValue(ref(db, `user_chats/${user.uid}`), async (s) => {
                const l = document.getElementById("chat-list");
                l.innerHTML = "";
                if(!s.exists()) return;

                const chats = s.val();
                for (const id in chats) {
                    const cData = chats[id];
                    // Get other user
                    const chatMeta = await get(ref(db, `chats/${id}`));
                    if(!chatMeta.exists()) continue;
                    const members = chatMeta.val().members;
                    const oid = members.find(m => m !== user.uid);
                    const ou = users[oid] || { username: "User", avatar: "" };

                    const div = document.createElement("div");
                    div.className = "chat-item";
                    div.innerHTML = `
                        <div class="avatar-wrapper">
                            <img src="${ou.avatar || `https://ui-avatars.com/api/?name=${ou.username}`}" class="chat-avatar">
                            ${ou.verified ? '<div class="verified-badge"><i class="material-icons-round" style="font-size:10px">check</i></div>' : ''}
                        </div>
                        <div class="chat-info">
                            <div class="chat-name">${ou.username}</div>
                            <div class="chat-msg">${cData.lastMessage}</div>
                        </div>
                    `;
                    div.onclick = () => openChat(id, oid);
                    l.appendChild(div);
                }
            });
        }

        function openChat(id, oid) {
            chatId = id;
            otherUid = oid;
            const ou = users[oid] || { username: "User" };
            
            document.getElementById("chat-room").classList.add("active");
            document.body.classList.add("chat-active");
            document.getElementById("curr-chat-name").innerText = ou.username;
            document.getElementById("curr-chat-avatar").src = ou.avatar || `https://ui-avatars.com/api/?name=${ou.username}`;
            if(ou.verified) document.getElementById("curr-chat-badge").classList.remove('hidden');
            else document.getElementById("curr-chat-badge").classList.add('hidden');

            const area = document.getElementById("messages-area");
            area.innerHTML = "";

            onValue(ref(db, `messages/${id}`), (s) => {
                area.innerHTML = "";
                if(s.exists()) {
                    const msgs = Object.values(s.val()).sort((a,b) => a.time - b.time);
                    msgs.forEach(m => {
                        const isMe = m.sender === user.uid;
                        const div = document.createElement("div");
                        div.className = `message-bubble ${isMe ? "sent" : "received"}`;
                        
                        let content = `<div>${m.text}</div>`;
                        if(m.type === 'img') {
                            content = `<img src="${m.text}" class="msg-img">`;
                        }

                        div.innerHTML = `
                            ${content}
                            <div class="msg-meta">${new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                        `;
                        area.appendChild(div);
                    });
                    area.scrollTop = area.scrollHeight;
                }
            });
        }

        document.getElementById("btn-back-chat").onclick = () => {
            document.getElementById("chat-room").classList.remove("active");
            document.body.classList.remove("chat-active");
            chatId = null;
        };

        // --- Sending Messages & Images ---
        document.getElementById("btn-send-msg").onclick = () => {
            const txt = document.getElementById("msg-input").value.trim();
            if(txt) sendMsg(txt, 'text');
        };

        document.getElementById("btn-attach").onclick = () => document.getElementById("file-input").click();

        // Image Compression & Sending Handler
        document.getElementById("file-input").onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (ev) => {
                const img = new Image();
                img.src = ev.target.result;
                img.onload = () => {
                    // Resize to max 800px width/height
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxDim = 800;
                    let w = img.width;
                    let h = img.height;

                    if (w > h) {
                        if (w > maxDim) { h *= maxDim / w; w = maxDim; }
                    } else {
                        if (h > maxDim) { w *= maxDim / h; h = maxDim; }
                    }

                    canvas.width = w;
                    canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    
                    // Compress to JPEG 0.7 quality
                    const base64 = canvas.toDataURL('image/jpeg', 0.7);
                    sendMsg(base64, 'img');
                    
                    // Reset input
                    document.getElementById("file-input").value = "";
                };
            };
        };

        async function sendMsg(content, type) {
            if(!chatId) return;
            const refMsgs = ref(db, `messages/${chatId}`);
            await push(refMsgs, {
                sender: user.uid,
                text: content,
                type: type,
                time: Date.now()
            });
            const lastMsg = type === 'img' ? 'Sent a photo' : content;
            update(ref(db, `user_chats/${user.uid}/${chatId}`), { lastMessage: lastMsg, timestamp: Date.now() });
            update(ref(db, `user_chats/${otherUid}/${chatId}`), { lastMessage: lastMsg, timestamp: Date.now() });
            
            if(type === 'text') document.getElementById("msg-input").value = "";
        }

        // --- Feed Logic (Instagram Style) ---
        function loadFeed() {
            onValue(ref(db, 'posts'), (s) => {
                const c = document.getElementById("feed-content");
                c.innerHTML = "";
                if(!s.exists()) return;
                
                const posts = Object.entries(s.val()).map(([k,v]) => ({key:k, ...v})).reverse(); // Newest first
                
                posts.forEach(p => {
                    const author = users[p.authorId] || {username:"Unknown"};
                    
                    if(p.type === 'money') {
                        const div = document.createElement("div");
                        div.className = "money-post-card";
                        div.innerHTML = `
                            <div>${p.amount} ETH</div>
                            <div style="font-size:12px; margin-top:5px;">@${author.username}</div>
                            <button class="money-claim-btn">Claim</button>
                        `;
                        c.appendChild(div);
                        return;
                    }

                    const div = document.createElement("div");
                    div.className = "post-card";
                    
                    let media = "";
                    if(p.type === 'img') media = `<img src="${p.content}" class="post-content-img">`;

                    div.innerHTML = `
                        <div class="post-header">
                            <img src="${author.avatar || `https://ui-avatars.com/api/?name=${author.username}`}" class="chat-avatar" style="width:32px;height:32px">
                            <div style="font-weight:600; font-size:14px">${author.username}</div>
                            ${author.verified ? '<i class="material-icons-round" style="font-size:14px; color:var(--verified-color)">check_circle</i>' : ''}
                        </div>
                        ${media}
                        <div class="post-actions">
                            <i class="material-icons-round" style="color:${p.likes && p.likes[user.uid] ? 'red' : 'inherit'}" onclick="window.likePost('${p.key}')">${p.likes && p.likes[user.uid] ? 'favorite' : 'favorite_border'}</i>
                            <i class="material-icons-round" onclick="window.openComments('${p.key}')">chat_bubble_outline</i>
                            <i class="material-icons-round">send</i>
                        </div>
                        <div class="post-likes">${p.likes ? Object.keys(p.likes).length : 0} likes</div>
                        <div class="post-caption">
                            <span class="username">${author.username}</span> ${p.caption || p.content || ''}
                        </div>
                        <div class="view-all-comments" onclick="window.openComments('${p.key}')">View all comments</div>
                    `;
                    c.appendChild(div);
                });
            });
        }

        window.likePost = (key) => {
            const r = ref(db, `posts/${key}/likes/${user.uid}`);
            get(r).then(s => {
                if(s.exists()) remove(r);
                else set(r, true);
            });
        };

        window.openComments = (key) => {
            currentCommentPostId = key;
            document.getElementById("modal-comments").classList.add("open");
            const list = document.getElementById("comments-list");
            list.innerHTML = "Loading...";
            
            onValue(ref(db, `comments/${key}`), (s) => {
                list.innerHTML = "";
                if(!s.exists()) {
                    list.innerHTML = "<div style='text-align:center; padding:10px; opacity:0.6'>No comments yet.</div>";
                    return;
                }
                const coms = Object.values(s.val());
                coms.forEach(c => {
                    const u = users[c.senderId] || {username:"User"};
                    const row = document.createElement("div");
                    row.className = "comment-item";
                    row.innerHTML = `<span class="comment-user">${u.username}</span> <span>${c.text}</span>`;
                    list.appendChild(row);
                });
            });
        };

        document.getElementById("btn-submit-comment").onclick = () => {
            const txt = document.getElementById("comment-input").value;
            if(!txt || !currentCommentPostId) return;
            push(ref(db, `comments/${currentCommentPostId}`), {
                senderId: user.uid,
                text: txt,
                time: Date.now()
            });
            document.getElementById("comment-input").value = "";
        };

        // --- Feed Posting Buttons ---
        document.getElementById("btn-post-text").onclick = () => document.getElementById("modal-post-text").classList.add("open");
        document.getElementById("btn-post-img").onclick = () => document.getElementById("modal-post-img").classList.add("open");
        document.getElementById("btn-post-money").onclick = () => document.getElementById("modal-post-money").classList.add("open");

        document.getElementById("btn-submit-post-text").onclick = () => {
            const t = document.getElementById("post-text-content").value;
            if(!t) return;
            push(ref(db, 'posts'), { type:'text', content:t, authorId:user.uid, timestamp:Date.now() });
            document.getElementById("modal-post-text").classList.remove("open");
        };

        // Post Image Handler
        const postImgFile = document.getElementById("post-img-file");
        postImgFile.onchange = (e) => {
            const f = e.target.files[0];
            if(f) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    document.getElementById("post-img-preview").src = ev.target.result;
                    document.getElementById("img-preview-container").classList.remove("hidden");
                }
                reader.readAsDataURL(f);
            }
        };

        document.getElementById("btn-submit-post-img").onclick = () => {
            const imgEl = document.getElementById("post-img-preview");
            const cap = document.getElementById("post-img-caption").value;
            // Simplified: Assuming src is dataURL (resize logic similar to chat can be applied here)
            push(ref(db, 'posts'), { type:'img', content: imgEl.src, caption: cap, authorId:user.uid, timestamp:Date.now() });
            document.getElementById("modal-post-img").classList.remove("open");
        };


        // --- Gemini AI Logic ---
        document.getElementById("btn-ai-send").onclick = async () => {
            const inp = document.getElementById("ai-input");
            const txt = inp.value.trim();
            if(!txt) return;

            const area = document.getElementById("ai-messages");
            area.innerHTML += `<div class="ai-message user">${txt}</div>`;
            inp.value = "";
            
            // Loading bubble
            const loader = document.createElement("div");
            loader.className = "ai-message bot";
            loader.innerText = "...";
            area.appendChild(loader);

            try {
                // Decode Key
                const API_KEY = atob(GEMINI_KEY_B64);
                
                // Using REST API for Gemini 1.5 Flash (Standard)
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: txt }] }]
                    })
                });

                const data = await response.json();
                loader.remove();

                if (data.candidates && data.candidates[0].content) {
                    const reply = data.candidates[0].content.parts[0].text;
                    // Simple bold formatting replacement
                    const formatted = reply.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
                    area.innerHTML += `<div class="ai-message bot">${formatted}</div>`;
                } else {
                    area.innerHTML += `<div class="ai-message bot" style="color:red">Error: Could not get response</div>`;
                }
            } catch (e) {
                loader.remove();
                area.innerHTML += `<div class="ai-message bot" style="color:red">Connection Error</div>`;
                console.error(e);
            }
            area.scrollTop = area.scrollHeight;
        };
        
        document.getElementById("btn-ai-clear").onclick = () => {
            document.getElementById("ai-messages").innerHTML = "";
        };

        // --- Other Interactions ---
        document.getElementById("btn-new-chat").onclick = () => {
            document.getElementById("modal-new-chat").classList.add("open");
            const res = document.getElementById("search-results");
            res.innerHTML = "";
            Object.values(users).forEach(u => {
                if(u.uid === user.uid) return;
                const d = document.createElement("div");
                d.className = "chat-item";
                d.innerHTML = `<img src="${u.avatar}" class="chat-avatar" style="width:30px;height:30px;margin-right:10px;"> ${u.username}`;
                d.onclick = () => {
                    // Create chat logic simplified
                    const cid = [user.uid, u.uid].sort().join("_");
                    set(ref(db, `chats/${cid}`), { members: [user.uid, u.uid] });
                    // Add to user_chats pointers... (omitted for brevity in display, assumed working in backend rules or init)
                    set(ref(db, `user_chats/${user.uid}/${cid}`), { lastMessage: "New Chat", timestamp: Date.now() });
                    set(ref(db, `user_chats/${u.uid}/${cid}`), { lastMessage: "New Chat", timestamp: Date.now() });
                    document.getElementById("modal-new-chat").classList.remove("open");
                    openChat(cid, u.uid);
                };
                res.appendChild(d);
            });
        };
        
        document.getElementById("theme-toggle").onchange = (e) => {
            if(e.target.checked) document.body.classList.add("light-mode");
            else document.body.classList.remove("light-mode");
        };

        document.getElementById("btn-logout").onclick = () => signOut(auth);

    </script>
</body>
</html>
