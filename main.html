<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypa Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <!-- Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-color: #0b0e14;
            --surface-color: #151921;
            --surface-light: #232833;
            --primary-color: #5b6bf2;
            --primary-hover: #4a59d1;
            --accent-color: #00dc82;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --border-color: #2d3748;
            --danger-color: #ff4757;
            --nav-height: 70px;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .flex-col { display: flex; flex-direction: column; }
        .scrollable { overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        .material-icons-round { font-size: 24px; }
        .icon-lg { font-size: 28px; }
        .icon-xl { font-size: 36px; }

        /* --- LAYOUT STRUCTURE --- */
        .view-container {
            flex: 1;
            position: relative;
            width: 100%;
            height: calc(100vh - var(--nav-height));
            display: none;
            flex-direction: column;
        }
        .view-container.active { display: flex; }

        /* --- HEADER --- */
        .app-header {
            height: 60px;
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            flex-shrink: 0;
            z-index: 10;
        }
        .app-title { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }

        /* --- SCROLLABLE AREAS --- */
        .content-area { flex: 1; overflow-y: auto; padding: 20px; position: relative; }

        /* --- NAVIGATION --- */
        .bottom-nav {
            height: var(--nav-height);
            background-color: var(--surface-color);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-secondary); cursor: pointer; width: 25%; height: 100%; transition: color 0.2s;
        }
        .nav-item.active { color: var(--primary-color); }
        .nav-item .material-icons-round { margin-bottom: 4px; }

        /* --- CHAT LIST --- */
        .chat-item {
            display: flex; align-items: center; padding: 16px; margin-bottom: 12px;
            background: var(--surface-light); border-radius: 16px; cursor: pointer; transition: background 0.2s;
        }
        .chat-item:hover { background: #2f3642; }
        .chat-avatar { width: 54px; height: 54px; border-radius: 50%; background: #333; object-fit: cover; margin-right: 16px; }
        .chat-info { flex: 1; overflow: hidden; }
        .chat-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
        .chat-msg { color: var(--text-secondary); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- CHAT ROOM --- */
        #chat-room {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 50;
            display: flex; flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #chat-room.active { transform: translateX(0); }

        .chat-room-header {
            height: 60px; background: rgba(21, 25, 33, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 10px; flex-shrink: 0;
        }
        
        .messages-container {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px;
        }

        .message-bubble {
            max-width: 80%; padding: 12px 18px; border-radius: 18px; position: relative;
            font-size: 15px; line-height: 1.4; word-wrap: break-word;
        }
        .message-bubble.sent {
            align-self: flex-end; background-color: var(--primary-color); color: white;
            border-bottom-right-radius: 4px;
        }
        .message-bubble.received {
            align-self: flex-start; background-color: var(--surface-light); color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }
        .msg-img { max-width: 100%; border-radius: 12px; display: block; }
        .msg-time { font-size: 11px; opacity: 0.7; text-align: right; margin-top: 4px; }
        
        .recall-btn {
            position: absolute; top: -6px; right: -6px; background: #fff; color: var(--danger-color);
            border-radius: 50%; width: 24px; height: 24px; display: none;
            align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer;
        }
        .message-bubble.sent:hover .recall-btn { display: flex; }

        /* --- INPUT AREA (CHAT & AI) --- */
        .input-bar {
            background: var(--surface-color); padding: 12px 16px;
            display: flex; align-items: flex-end; gap: 12px;
            border-top: 1px solid var(--border-color); flex-shrink: 0;
        }
        .text-input {
            flex: 1; background: var(--bg-color); border: 1px solid var(--border-color);
            border-radius: 24px; padding: 12px 18px; color: white; font-family: inherit;
            font-size: 15px; resize: none; max-height: 120px; outline: none; overflow-y: hidden; min-height: 46px;
        }
        .text-input:focus { border-color: var(--primary-color); }
        
        .action-btn {
            width: 46px; height: 46px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.92); }
        .btn-icon { color: var(--text-secondary); background: transparent; }
        .btn-icon:hover { background: rgba(255,255,255,0.05); color: white; }
        .btn-send { background: var(--primary-color); color: white; box-shadow: 0 4px 12px rgba(91, 107, 242, 0.3); }
        .btn-money { background: #fbbf24; color: #000; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3); }

        /* --- AI CHAT BUBBLES --- */
        .ai-message {
            max-width: 85%; padding: 16px 20px; border-radius: 18px; margin-bottom: 16px;
            line-height: 1.5; font-size: 15px; display: flex; flex-direction: column;
        }
        .ai-message.user {
            background: var(--primary-color); color: white;
            align-self: flex-end; /* User Right */
            border-bottom-right-radius: 4px;
        }
        .ai-message.bot {
            background: var(--surface-light); color: white;
            align-self: flex-start; /* AI Left */
            border-bottom-left-radius: 4px;
        }
        .typing-indicator {
            display: flex; gap: 4px; padding: 4px 0;
        }
        .dot {
            width: 8px; height: 8px; background: var(--text-secondary); border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* --- FULLSCREEN LOADER --- */
        .fullscreen-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid var(--surface-light);
            border-top: 5px solid var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- IMAGE PREVIEW MODAL --- */
        .image-preview-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 900;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .preview-img {
            max-width: 90%; max-height: 70%; border-radius: 12px; border: 2px solid var(--border-color);
            margin-bottom: 30px;
        }
        .preview-actions { display: flex; gap: 20px; width: 90%; justify-content: center; }
        .preview-btn {
            flex: 1; padding: 15px; border-radius: 12px; border: none;
            font-size: 16px; font-weight: 600; cursor: pointer;
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200;
            display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-content {
            background: var(--surface-color); width: 90%; max-width: 400px; border-radius: 20px;
            padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            transform: scale(0.9); transition: transform 0.2s;
        }
        .modal-overlay.open .modal-content { transform: scale(1); }
        .modal-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; text-align: center; }
        .input-field {
            width: 100%; background: var(--bg-color); border: 1px solid var(--border-color);
            padding: 14px; border-radius: 12px; color: white; margin-bottom: 16px;
            font-size: 15px; outline: none;
        }
        .input-field:focus { border-color: var(--primary-color); }
        .btn-primary {
            width: 100%; background: var(--primary-color); color: white; padding: 14px;
            border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;
        }

        /* --- WALLET CARD --- */
        .wallet-card {
            background: linear-gradient(135deg, #232833, #151921); border: 1px solid var(--border-color);
            border-radius: 20px; padding: 20px; margin-bottom: 20px; position: relative; overflow: hidden;
        }
        .wallet-balance { font-size: 28px; font-weight: 800; margin: 10px 0; }
        .wallet-address {
            background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 8px;
            font-family: monospace; font-size: 12px; color: var(--text-secondary);
            word-break: break-all; margin-bottom: 15px;
        }

        /* --- TOAST --- */
        .toast {
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: var(--surface-light); border: 1px solid var(--primary-color);
            color: white; padding: 12px 24px; border-radius: 50px; font-size: 14px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); opacity: 0; pointer-events: none;
            transition: 0.3s; z-index: 999;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* --- CHAT MONEY POPUP --- */
        .chat-money-popup {
            position: absolute; bottom: 80px; left: 15px; right: 15px;
            background: var(--surface-light); border-radius: 16px; padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 60;
            display: none; flex-direction: column; gap: 15px; border: 1px solid var(--border-color);
        }
    </style>
</head>
<body>

    <div id="toast" class="toast">Notification</div>

    <!-- FULLSCREEN LOADER -->
    <div id="fullscreen-loader" class="fullscreen-loader">
        <div class="spinner"></div>
        <p style="margin-top: 20px; font-size: 16px; font-weight: 500;">Compressing Image (Max 90KB)...</p>
    </div>

    <!-- IMAGE PREVIEW MODAL -->
    <div id="image-preview-modal" class="image-preview-modal">
        <img id="preview-image-element" class="preview-img" src="">
        <div class="preview-actions">
            <button id="btn-cancel-image" class="preview-btn" style="background: var(--danger-color); color: white;">
                <i class="material-icons-round" style="vertical-align:middle; margin-right:5px">delete</i> Delete
            </button>
            <button id="btn-confirm-image" class="preview-btn" style="background: var(--primary-color); color: white;">
                <i class="material-icons-round" style="vertical-align:middle; margin-right:5px">send</i> Send
            </button>
        </div>
    </div>

    <!-- CHAT VIEW -->
    <div id="view-chat" class="view-container active">
        <div class="app-header">
            <div class="app-title">Chats</div>
        </div>
        <div id="chat-list" class="content-area"></div>
        <button id="btn-new-chat" class="material-icons-round btn-send" style="position: absolute; bottom: 85px; right: 20px; z-index: 40; border-radius: 16px;">add</button>

        <!-- CHAT ROOM OVERLAY -->
        <div id="chat-room">
            <div class="chat-room-header">
                <button class="action-btn btn-icon" id="btn-back-chat"><i class="material-icons-round">arrow_back</i></button>
                <div class="flex-center" style="flex: 1; margin: 0 15px; background: var(--bg-color); border-radius: 30px; padding: 6px 15px;">
                    <img src="" id="current-chat-avatar" class="chat-avatar" style="width: 32px; height: 32px; margin-right: 10px;">
                    <span id="current-chat-name" style="font-weight: 600; font-size: 15px;">User</span>
                </div>
            </div>
            
            <div id="messages-area" class="messages-container"></div>

            <!-- CHAT MONEY POPUP -->
            <div id="send-money-popup" class="chat-money-popup">
                <h4 style="color: var(--text-secondary); font-size: 14px;">Send Crypto</h4>
                <select id="transfer-select" class="input-field"></select>
                <input type="number" id="transfer-amount" class="input-field" placeholder="Amount">
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button id="btn-cancel-transfer" style="background:transparent; border:none; color:white; padding:10px;"><i class="material-icons-round">close</i></button>
                    <button id="btn-confirm-transfer" class="action-btn btn-send" style="width: 40px; height: 40px;"><i class="material-icons-round">check</i></button>
                </div>
            </div>

            <div class="input-bar">
                <button class="action-btn btn-money" id="btn-send-money"><i class="material-icons-round">attach_money</i></button>
                <button class="action-btn btn-icon" id="btn-attach"><i class="material-icons-round">add</i></button>
                <input type="file" id="file-input" accept="image/*" style="display: none;">
                <textarea id="msg-input" class="text-input" rows="1" placeholder="Type a message..."></textarea>
                <button class="action-btn btn-send" id="btn-send"><i class="material-icons-round">send</i></button>
            </div>
        </div>
    </div>

    <!-- AI VIEW -->
    <div id="view-ai" class="view-container">
        <div class="app-header">
            <div class="app-title">Crypa AI</div>
            <button class="action-btn btn-icon" id="btn-ai-clear"><i class="material-icons-round">delete_outline</i></button>
        </div>
        <div id="ai-messages" class="content-area scrollable" style="padding-bottom: 20px;"></div>
        <!-- FIXED AI INPUT -->
        <div class="input-bar" style="border-top: 1px solid var(--border-color);">
            <textarea id="ai-input" class="text-input" rows="1" placeholder="Ask Crypa AI..."></textarea>
            <button class="action-btn btn-send" id="btn-ai-send"><i class="material-icons-round">send</i></button>
        </div>
    </div>

    <!-- CHANNELS VIEW -->
    <div id="view-channels" class="view-container">
        <div class="app-header">
            <div class="app-title">Channels</div>
        </div>
        <div id="channels-list" class="content-area"></div>
        <button id="btn-create-channel" class="material-icons-round btn-send" style="position: absolute; bottom: 85px; right: 20px; z-index: 40; border-radius: 16px; background: #10b981; color: white;">add</button>
    </div>

    <!-- PROFILE VIEW -->
    <div id="view-profile" class="view-container">
        <div class="app-header">
            <div class="app-title">Profile</div>
        </div>
        <div class="content-area">
            <div class="wallet-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 14px; color: var(--text-secondary); font-weight: 600;">MY WALLET</span>
                    <i class="material-icons-round icon-lg" style="color: var(--primary-color);">account_balance_wallet</i>
                </div>
                <div id="wallet-balance-display">0.00 ETH</div>
                <div class="wallet-address" id="wallet-address-display">Connecting...</div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" style="background: var(--surface-light); flex: 1;" id="btn-deposit">Receive</button>
                    <button class="btn-primary" style="background: var(--surface-light); flex: 1;" id="btn-withdraw">Send</button>
                </div>
            </div>

            <div style="display: flex; align-items: center; background: var(--surface-light); padding: 16px; border-radius: 16px; margin-bottom: 20px;">
                <img src="" id="profile-avatar" class="chat-avatar" style="width: 60px; height: 60px; margin-right: 16px;">
                <div>
                    <h3 id="profile-username" style="font-size: 18px; font-weight: 700;">Username</h3>
                    <p style="color: var(--text-secondary); font-size: 14px;">Online</p>
                </div>
            </div>

            <button class="btn-primary" style="background: var(--surface-light); margin-bottom: 15px;" id="btn-notifications">
                <i class="material-icons-round" style="vertical-align: middle; margin-right: 8px;">notifications</i> Notifications
            </button>
            <button class="btn-primary" style="background: var(--surface-light); margin-bottom: 15px;" id="btn-privacy">
                <i class="material-icons-round" style="vertical-align: middle; margin-right: 8px;">lock</i> Privacy
            </button>
            
            <button class="btn-primary" style="background: var(--danger-color);" id="btn-logout">Logout</button>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
        <div class="nav-item active" data-target="view-chat"><i class="material-icons-round">chat</i><span style="font-size: 12px; font-weight: 500;">Chat</span></div>
        <div class="nav-item" data-target="view-ai"><i class="material-icons-round">smart_toy</i><span style="font-size: 12px; font-weight: 500;">AI</span></div>
        <div class="nav-item" data-target="view-channels"><i class="material-icons-round">groups</i><span style="font-size: 12px; font-weight: 500;">Channels</span></div>
        <div class="nav-item" data-target="view-profile"><i class="material-icons-round">person</i><span style="font-size: 12px; font-weight: 500;">Profile</span></div>
    </div>

    <!-- NEW CHAT MODAL -->
    <div id="modal-new-chat" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">New Chat</h3>
            <input type="text" id="search-username" class="input-field" placeholder="Enter username...">
            <div id="search-result" class="hidden flex-center flex-col" style="margin-top: 20px;">
                <img src="" id="search-avatar" class="chat-avatar" style="width: 80px; height: 80px;">
                <h3 id="search-name" style="margin: 10px 0;">Name</h3>
                <button id="btn-start-chat" class="btn-primary">Message</button>
            </div>
            <button class="btn-primary" style="background: transparent; border: 1px solid var(--border-color); margin-top: 10px;" id="btn-close-modal">Close</button>
        </div>
    </div>

    <!-- WALLET MODAL -->
    <div id="modal-wallet" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title" id="wallet-modal-title">Receive Funds</h3>
            <div id="wallet-modal-body"></div>
            <button class="btn-primary" style="margin-top: 15px;" onclick="document.getElementById('modal-wallet').classList.remove('open')">Close</button>
        </div>
    </div>

    <!-- CREATE CHANNEL MODAL -->
    <div id="modal-channel" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">Create Channel</h3>
            <input type="text" id="channel-name" class="input-field" placeholder="Channel Name">
            <button id="btn-submit-channel" class="btn-primary">Create</button>
            <button class="btn-primary" style="background: transparent; border: 1px solid var(--border-color); margin-top: 10px;" id="btn-close-channel">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, remove, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAAy3uUW0adMIMfPVRZXZkOHipi3y1v7gs",
            authDomain: "crypa-f60b0.firebaseapp.com",
            databaseURL: "https://crypa-f60b0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "crypa-f60b0",
            storageBucket: "crypa-f60b0.firebasestorage.app",
            messagingSenderId: "504499957380",
            appId: "1:504499957380:web:0dd3cb2e0f9fd15a451cd1",
            measurementId: "G-TVX60TVN7S"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // API Key
        const openRouterKeyEncoded = "c2stb3ItdjEtZmE0MTcwMTU0NDUyNzgzOGZiOWFkODkwODJlOWQyOTIxYmJlZmU0N2Q2N2IzMjZkY2Q3NDlmMWZiNGYyYjNlOA==";
        const openRouterKey = atob(openRouterKeyEncoded);

        // State
        let currentUser = null;
        let currentChatId = null;
        let otherUserUid = null;
        let myWallets = {};
        let compressedImageBase64 = null;
        
        // Real Blockchain Provider
        const provider = new ethers.JsonRpcProvider("https://cloudflare-eth.com");

        // Cache (Optimized)
        const getCache = (key) => JSON.parse(localStorage.getItem(key) || 'null');
        const setCache = (key, val) => {
            try {
                localStorage.setItem(key, JSON.stringify(val));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    Object.keys(localStorage).forEach(k => { 
                        if(k.startsWith('crypa_chat_') && k !== key) localStorage.removeItem(k); 
                    });
                    try { localStorage.setItem(key, JSON.stringify(val)); } catch(err) {}
                }
            }
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // --- NAVIGATION ---
        const navItems = document.querySelectorAll('.nav-item');
        const views = document.querySelectorAll('.view-container');

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                const target = item.getAttribute('data-target');
                views.forEach(v => v.classList.remove('active'));
                document.getElementById(target).classList.add('active');
            });
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                initApp();
            } else {
                window.location.href = 'index.html';
            }
        });

        async function initApp() {
            // Profile
            const uData = getCache('crypa_user');
            if(uData) {
                document.getElementById('profile-avatar').src = uData.avatar || `https://ui-avatars.com/api/?name=${uData.username}&background=random`;
                document.getElementById('profile-username').innerText = uData.username || 'User';
            }

            // Wallets
            await initWallets();

            loadChats();
            initAI();
            loadChannels();
        }

        // --- IMAGE COMPRESSION ENGINE ---
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        // Resize if too big
                        if(width > 1024) {
                            height = Math.round(height * (1024 / width));
                            width = 1024;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Compress loop (Target < 90KB)
                        let quality = 0.6;
                        let dataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        // Estimate size (base64 length * 0.75)
                        while (dataUrl.length * 0.75 > 90000 && quality > 0.05) {
                            quality -= 0.05;
                            dataUrl = canvas.toDataURL('image/jpeg', quality);
                        }
                        resolve(dataUrl);
                    };
                };
            });
        }

        // --- WALLET SYSTEM ---
        async function initWallets() {
            const wSnap = await get(ref(db, `users/${currentUser.uid}/wallets`));
            
            if (!wSnap.exists()) {
                const ethWallet = ethers.Wallet.createRandom();
                
                myWallets = {
                    eth: { address: ethWallet.address, privateKey: ethWallet.privateKey, balance: "0.0", symbol: "ETH" },
                    usdt: { address: ethWallet.address, balance: "0.0", symbol: "USDT" }
                };
                
                await set(ref(db, `users/${currentUser.uid}/wallets`), {
                    eth: { address: myWallets.eth.address, balance: "0.0", symbol: "ETH" },
                    usdt: { address: myWallets.usdt.address, balance: "0.0", symbol: "USDT" }
                });
                
                sessionStorage.setItem('crypa_keys', JSON.stringify({ eth: ethWallet.privateKey }));
            } else {
                const dbWallets = wSnap.val();
                const keys = JSON.parse(sessionStorage.getItem('crypa_keys') || '{}');
                
                myWallets = {};
                for(const key in dbWallets) {
                    myWallets[key] = { ...dbWallets[key], privateKey: keys[key] || null };
                }
                checkRealBalances();
            }
            updateWalletUI();
        }

        async function checkRealBalances() {
            if(myWallets.eth && myWallets.eth.address) {
                try {
                    const bal = await provider.getBalance(myWallets.eth.address);
                    const formatted = parseFloat(ethers.formatEther(bal)).toFixed(4);
                    myWallets.eth.balance = formatted;
                    updateWalletUI();
                    update(ref(db, `users/${currentUser.uid}/wallets/eth`), { balance: formatted });
                } catch(e) { console.log("RPC Error:", e); }
            }
        }

        function updateWalletUI() {
            document.getElementById('wallet-balance-display').innerText = `${myWallets.eth?.balance || "0.00"} ${myWallets.eth?.symbol || "ETH"}`;
            document.getElementById('wallet-address-display').innerText = myWallets.eth?.address || "...";
            
            const select = document.getElementById('transfer-select');
            select.innerHTML = '';
            Object.keys(myWallets).forEach(k => {
                const opt = document.createElement('option');
                opt.value = k;
                opt.text = `${myWallets[k].symbol} (${myWallets[k].balance})`;
                select.appendChild(opt);
            });
        }

        // Wallet Modals
        document.getElementById('btn-deposit').onclick = () => {
            document.getElementById('wallet-modal-title').innerText = "Receive Funds";
            document.getElementById('wallet-modal-body').innerHTML = `
                <p class="text-center" style="color: var(--text-secondary); margin-bottom: 10px;">Scan or Copy Address</p>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; word-break: break-all; font-family: monospace; font-size: 12px; text-align: center; border: 1px solid var(--primary-color);">
                    ${myWallets.eth.address}
                </div>
                <p style="font-size: 12px; color: var(--text-secondary); margin-top: 10px; text-align: center;">Only send ETH to this address.</p>
            `;
            document.getElementById('modal-wallet').classList.add('open');
        };

        document.getElementById('btn-withdraw').onclick = () => {
            document.getElementById('wallet-modal-title').innerText = "Send to External Wallet";
            document.getElementById('wallet-modal-body').innerHTML = `
                <input type="text" id="withdraw-addr" class="input-field" placeholder="0x Address">
                <input type="number" id="withdraw-amt" class="input-field" placeholder="Amount">
                <button class="btn-primary" onclick="window.executeWithdraw()">Send</button>
            `;
            document.getElementById('modal-wallet').classList.add('open');
        };

        window.executeWithdraw = async () => {
            const addr = document.getElementById('withdraw-addr').value;
            const amt = parseFloat(document.getElementById('withdraw-amt').value);
            if(!addr || !amt) { showToast("Invalid input"); return; }
            if(amt > parseFloat(myWallets.eth.balance)) { showToast("Insufficient Balance"); return; }

            showToast("Broadcasting Transaction...");
            document.getElementById('modal-wallet').classList.remove('open');

            try {
                const wallet = new ethers.Wallet(myWallets.eth.privateKey, provider);
                const tx = await wallet.sendTransaction({
                    to: addr, value: ethers.parseEther(amt.toString())
                });
                showToast("Sent! Waiting for confirmation...");
                await tx.wait();
                showToast("Transaction Confirmed!");
                checkRealBalances();
            } catch (error) {
                console.error(error);
                showToast("Transaction Failed (Check Gas/Network)");
            }
        };

        // --- CHAT SECTION ---
        function loadChats() {
            onValue(ref(db, `user_chats/${currentUser.uid}`), async (snapshot) => {
                const list = document.getElementById('chat-list');
                list.innerHTML = '';
                const data = snapshot.val();
                if (!data) { list.innerHTML = '<div class="flex-center" style="height:200px; color: var(--text-secondary);">No Chats</div>'; return; }
                
                const chatIds = Object.keys(data).sort((a,b) => data[b].timestamp - data[a].timestamp);
                for (const chatId of chatIds) {
                    const chatSnap = await get(ref(db, `chats/${chatId}`));
                    if(!chatSnap.exists()) continue;
                    const chatData = chatSnap.val();
                    const otherId = chatData.members.find(m => m !== currentUser.uid);
                    const uData = (await get(ref(db, `users/${otherId}`))).val();
                    if(!uData) continue;

                    const div = document.createElement('div');
                    div.className = "chat-item";
                    div.innerHTML = `
                        <img src="${uData.avatar}" class="chat-avatar">
                        <div class="chat-info">
                            <div class="chat-name">${uData.username}</div>
                            <div class="chat-msg">${data[chatId].lastMessage || 'New Chat'}</div>
                        </div>
                    `;
                    div.onclick = () => openChat(chatId, uData);
                    list.appendChild(div);
                }
            });
        }

        async function openChat(chatId, uData) {
            currentChatId = chatId;
            otherUserUid = uData.uid;
            document.getElementById('chat-room').classList.add('active');
            document.getElementById('current-chat-avatar').src = uData.avatar;
            document.getElementById('current-chat-name').innerText = uData.username;
            loadMessages(chatId);
        }

        function loadMessages(chatId) {
            const area = document.getElementById('messages-area');
            area.innerHTML = '';
            const cachedMsgs = getCache(`crypa_chat_${chatId}`);
            if (cachedMsgs) {
                cachedMsgs.forEach(msg => renderMsg(msg));
                area.scrollTop = area.scrollHeight;
            }
            onValue(ref(db, `messages/${chatId}`), (snapshot) => {
                const data = snapshot.val();
                if(!data) return;
                area.innerHTML = '';
                const msgsArray = Object.values(data).sort((a,b) => a.timestamp - b.timestamp);
                const toCache = msgsArray.filter(m => m.type !== 'image').slice(-50);
                setCache(`crypa_chat_${chatId}`, toCache);
                msgsArray.forEach(msg => renderMsg(msg));
                area.scrollTop = area.scrollHeight;
            });
        }

        function renderMsg(msg) {
            const isMe = msg.senderId === currentUser.uid;
            const div = document.createElement('div');
            div.className = `message-bubble ${isMe ? 'sent' : 'received'}`;
            
            let content = msg.content;
            if(msg.type === 'image') content = `<img src="${msg.content}" class="msg-img">`;
            if(msg.type === 'transaction') content = `<i class="material-icons-round" style="vertical-align:middle; font-size:16px; margin-right:5px; color:#10b981;">attach_money</i> ${msg.content}`;
            
            const time = new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            div.innerHTML = `
                ${content}
                <div class="msg-time">${time}</div>
                ${isMe ? `<i class="material-icons-round recall-btn" style="font-size:16px;" onclick="window.recallMsg('${msg.key}', this)">delete</i>` : ''}
            `;
            document.getElementById('messages-area').appendChild(div);
        }

        window.recallMsg = (key, btn) => {
            btn.parentElement.style.opacity = '0';
            setTimeout(() => btn.parentElement.remove(), 200);
            remove(ref(db, `messages/${currentChatId}/${key}`));
        };

        async function sendMsg(fileData = null, type = 'text') {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text && !fileData) return;

            const msgRef = push(ref(db, `messages/${currentChatId}`));
            const msgData = {
                senderId: currentUser.uid,
                content: fileData || text,
                timestamp: Date.now(),
                type: type,
                key: msgRef.key
            };

            renderMsg(msgData);
            set(msgRef, msgData);
            
            const lastMsg = type === 'image' ? 'Sent a photo' : text;
            update(ref(db, `user_chats/${currentUser.uid}/${currentChatId}`), { lastMessage: lastMsg, timestamp: Date.now() });
            if(otherUserUid) {
                update(ref(db, `user_chats/${otherUserUid}/${currentChatId}`), { lastMessage: lastMsg, timestamp: Date.now() });
            }

            input.value = '';
            input.style.height = 'auto';
        }

        // Image Upload Flow with Compression
        const fileInput = document.getElementById('file-input');
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            // 1. Show Loader
            document.getElementById('fullscreen-loader').style.display = 'flex';
            
            // 2. Compress
            setTimeout(async () => { // Allow UI to update before freezing for compress
                try {
                    const compressed = await compressImage(file);
                    compressedImageBase64 = compressed;
                    
                    // 3. Hide Loader, Show Preview
                    document.getElementById('fullscreen-loader').style.display = 'none';
                    document.getElementById('preview-image-element').src = compressed;
                    document.getElementById('image-preview-modal').style.display = 'flex';
                } catch (err) {
                    showToast("Error compressing image");
                    document.getElementById('fullscreen-loader').style.display = 'none';
                }
            }, 100);
        });

        document.getElementById('btn-cancel-image').onclick = () => {
            document.getElementById('image-preview-modal').style.display = 'none';
            compressedImageBase64 = null;
        };
        document.getElementById('btn-confirm-image').onclick = () => {
            document.getElementById('image-preview-modal').style.display = 'none';
            if(compressedImageBase64) sendMsg(compressedImageBase64, 'image');
        };

        // Inputs
        const resizeInput = (e) => {
            e.target.style.height = 'auto';
            e.target.style.height = e.target.scrollHeight + 'px';
        };
        
        document.getElementById('btn-send').onclick = () => sendMsg();
        document.getElementById('msg-input').onkeydown = (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
            resizeInput(e);
        };
        document.getElementById('msg-input').addEventListener('input', resizeInput);

        document.getElementById('btn-attach').onclick = () => fileInput.click();
        document.getElementById('btn-back-chat').onclick = () => {
            document.getElementById('chat-room').classList.remove('active');
            currentChatId = null;
        };

        // --- CHAT MONEY TRANSFER ---
        document.getElementById('btn-send-money').onclick = () => { document.getElementById('send-money-popup').style.display = 'flex'; };
        document.getElementById('btn-cancel-transfer').onclick = () => { document.getElementById('send-money-popup').style.display = 'none'; };
        document.getElementById('btn-confirm-transfer').onclick = async () => {
            const asset = document.getElementById('transfer-select').value;
            const amount = parseFloat(document.getElementById('transfer-amount').value);
            
            if(!amount || amount <= 0) { showToast("Invalid amount"); return; }
            
            const current = parseFloat(myWallets[asset].balance);
            if(current < amount) { showToast("Insufficient funds"); return; }

            const senderNew = (current - amount).toFixed(4);
            myWallets[asset].balance = senderNew;
            update(ref(db, `users/${currentUser.uid}/wallets/${asset}`), { balance: senderNew });
            
            const receiverSnap = await get(ref(db, `users/${otherUserUid}/wallets/${asset}`));
            let receiverNew = amount.toFixed(4);
            if(receiverSnap.exists()) {
                receiverNew = (parseFloat(receiverSnap.val().balance) + amount).toFixed(4);
            }
            update(ref(db, `users/${otherUserUid}/wallets/${asset}`), { balance: receiverNew });

            updateWalletUI();
            
            const msgRef = push(ref(db, `messages/${currentChatId}`));
            await set(msgRef, {
                senderId: currentUser.uid,
                content: `Sent ${amount} ${asset.toUpperCase()}`,
                timestamp: Date.now(),
                type: 'transaction',
                key: msgRef.key
            });
            
            document.getElementById('send-money-popup').style.display = 'none';
            document.getElementById('transfer-amount').value = '';
            showToast("Transfer Successful!");
        };

        // --- AI SECTION ---
        const AI_SYS_PROMPT = "You are Crypa AI. You help users with the Crypa app and answer questions about Crypto. You were developed by Itumo Longinus ILC company. Keep messages short and helpful.";
        let aiHistory = [];

        function initAI() {
            const stored = getCache('crypa_ai_msgs');
            const now = Date.now();
            if(stored) {
                aiHistory = stored.filter(m => now - m.timestamp < 7 * 24 * 60 * 60 * 1000);
                renderAI();
            }
        }

        function renderAI() {
            const area = document.getElementById('ai-messages');
            area.innerHTML = '';
            aiHistory.forEach(m => {
                const div = document.createElement('div');
                div.className = `ai-message ${m.role === 'user' ? 'user' : 'bot'}`;
                div.innerText = m.content;
                area.appendChild(div);
            });
            setCache('crypa_ai_msgs', aiHistory);
            area.scrollTop = area.scrollHeight;
        }

        document.getElementById('btn-ai-send').onclick = async () => {
            const input = document.getElementById('ai-input');
            const text = input.value.trim();
            if(!text) return;

            // 1. Render User Message (Right)
            aiHistory.push({ role: 'user', content: text, timestamp: Date.now() });
            renderAI();
            input.value = '';

            // 2. Render Loading Bubble (Left, after last message)
            const area = document.getElementById('ai-messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'ai-message bot';
            loadingDiv.id = 'ai-loading-bubble';
            loadingDiv.innerHTML = '<div class="typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
            area.appendChild(loadingDiv);
            area.scrollTop = area.scrollHeight;

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${openRouterKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": "mistralai/mistral-7b-instruct:free",
                        "messages": [
                            { "role": "system", "content": AI_SYS_PROMPT },
                            ...aiHistory.map(h => ({ role: h.role, content: h.content }))
                        ]
                    })
                });

                const data = await response.json();
                const reply = data.choices[0].message.content;

                // 3. Remove Loading Bubble
                const loader = document.getElementById('ai-loading-bubble');
                if(loader) loader.remove();

                // 4. Render AI Reply (Left)
                aiHistory.push({ role: 'assistant', content: reply, timestamp: Date.now() });
                renderAI();

            } catch (e) {
                const loader = document.getElementById('ai-loading-bubble');
                if(loader) loader.remove();
                aiHistory.push({ role: 'assistant', content: "Error connecting to AI.", timestamp: Date.now() });
                renderAI();
            }
        };

        document.getElementById('btn-ai-clear').onclick = () => {
            // JavaScript Alert to confirm
            const confirmClear = window.confirm("Are you sure you want to clear the AI chat history?");
            if(confirmClear) {
                aiHistory = [];
                localStorage.removeItem('crypa_ai_msgs');
                renderAI();
            }
        };
        document.getElementById('ai-input').onkeydown = (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('btn-ai-send').click(); }
            resizeInput(e);
        };
        document.getElementById('ai-input').addEventListener('input', resizeInput);

        // --- CHANNELS ---
        function loadChannels() {
            onValue(ref(db, 'channels'), (snap) => {
                const container = document.getElementById('channels-list');
                container.innerHTML = '';
                const data = snap.val();
                if(!data) { container.innerHTML = '<div class="flex-center" style="height:200px; color: var(--text-secondary);">No Channels</div>'; return; }
                
                Object.keys(data).forEach(cid => {
                    const ch = data[cid];
                    const div = document.createElement('div');
                    div.className = "chat-item";
                    div.innerHTML = `
                        <div class="chat-info">
                            <div class="chat-name">${ch.name}</div>
                            <div class="chat-msg" style="color:var(--primary-color); font-size:12px;">ID: ${cid}</div>
                        </div>
                        <i class="material-icons-round icon-lg">chevron_right</i>
                    `;
                    div.onclick = () => openChannel(cid, ch);
                    container.appendChild(div);
                });
            });
        }

        function openChannel(cid, ch) {
            currentChatId = cid;
            otherUserUid = null;
            document.getElementById('chat-room').classList.add('active');
            document.getElementById('current-chat-avatar').src = `https://ui-avatars.com/api/?name=${ch.name}&background=random`;
            document.getElementById('current-chat-name').innerText = ch.name;
            loadMessages(cid);
        }

        document.getElementById('btn-create-channel').onclick = () => document.getElementById('modal-channel').classList.add('open');
        document.getElementById('btn-close-channel').onclick = () => document.getElementById('modal-channel').classList.remove('open');
        document.getElementById('btn-submit-channel').onclick = async () => {
            const name = document.getElementById('channel-name').value;
            if(!name) return;
            const cid = push(ref(db, 'channels')).key;
            await set(ref(db, `channels/${cid}`), { name: name, createdBy: currentUser.uid });
            document.getElementById('modal-channel').classList.remove('open');
        };

        // --- MODALS ---
        document.getElementById('btn-new-chat').onclick = () => document.getElementById('modal-new-chat').classList.add('open');
        document.getElementById('btn-close-modal').onclick = () => document.getElementById('modal-new-chat').classList.remove('open');
        
        document.getElementById('search-username').addEventListener('input', async (e) => {
            const val = e.target.value.trim().toLowerCase();
            if(val.length < 3) return;
            const snap = await get(ref(db, 'users'));
            let found = null;
            snap.forEach(c => {
                if(c.val().username.toLowerCase() === val && c.key !== currentUser.uid) {
                    found = { uid: c.key, ...c.val() };
                    return true;
                }
            });

            if(found) {
                const res = document.getElementById('search-result');
                res.classList.remove('hidden');
                document.getElementById('search-avatar').src = found.avatar || `https://ui-avatars.com/api/?name=${found.username}&background=random`;
                document.getElementById('search-name').innerText = found.username;
                document.getElementById('btn-start-chat').onclick = () => startChat(found);
            } else {
                document.getElementById('search-result').classList.add('hidden');
            }
        });

        async function startChat(target) {
            const ids = [currentUser.uid, target.uid].sort();
            const chatId = ids.join('_');
            await set(ref(db, `chats/${chatId}`), { members: ids, timestamp: Date.now() });
            document.getElementById('modal-new-chat').classList.remove('open');
            openChat(chatId, target);
        }

        document.getElementById('btn-notifications').onclick = () => showToast("No new notifications");
        document.getElementById('btn-privacy').onclick = () => showToast("Privacy Settings (Locked)");
        document.getElementById('btn-logout').onclick = () => {
            signOut(auth);
            localStorage.clear();
            window.location.href = 'index.html';
        };

    </script>
</body>
</html>
