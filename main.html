<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Crypa Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Round"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
      :root {
        --bg-color: #0b0e14;
        --surface-color: #151921;
        --surface-light: #232833;
        --primary-color: #5b6bf2;
        --text-primary: #ffffff;
        --text-secondary: #9ca3af;
        --border-color: #2d3748;
        --danger-color: #ff4757;
        --nav-height: 75px;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-primary);
        height: 100vh;
        width: 100vw;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .hidden {
        display: none !important;
      }
      .flex-center {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .scrollable {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .view-container {
        flex: 1;
        position: relative;
        width: 100%;
        height: calc(100vh - var(--nav-height));
        display: none;
        flex-direction: column;
      }
      .view-container.active {
        display: flex;
      }
      .app-header {
        height: 65px;
        background-color: var(--surface-color);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        flex-shrink: 0;
        z-index: 10;
      }
      .app-title {
        font-size: 22px;
        font-weight: 700;
      }
      .bottom-nav {
        height: var(--nav-height);
        background-color: var(--surface-color);
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding-bottom: env(safe-area-inset-bottom);
      }
      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        cursor: pointer;
        width: 33%;
        height: 100%;
        transition: 0.2s;
      }
      .nav-item.active {
        color: var(--primary-color);
      }
      .nav-item span {
        font-size: 11px;
        margin-top: 4px;
        font-weight: 500;
      }
      .chat-item {
        display: flex;
        align-items: center;
        padding: 16px;
        margin: 0 15px 12px 15px;
        background: var(--surface-light);
        border-radius: 18px;
        cursor: pointer;
      }
      .chat-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 15px;
        background: #333;
      }
      .chat-info {
        flex: 1;
        overflow: hidden;
      }
      .chat-name {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 2px;
      }
      .chat-msg {
        color: var(--text-secondary);
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      #chat-room {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-color);
        z-index: 50;
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      #chat-room.active {
        transform: translateX(0);
      }
      .chat-room-header {
        height: 65px;
        background: var(--surface-color);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        padding: 0 15px;
      }
      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .message-bubble,
      .ai-message {
        max-width: 80%;
        width: fit-content;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 15px;
        line-height: 1.4;
        word-wrap: break-word;
        position: relative;
      }
      .sent,
      .user {
        align-self: flex-end;
        background: var(--primary-color);
        color: white;
        border-bottom-right-radius: 4px;
      }
      .received,
      .bot {
        align-self: flex-start;
        background: var(--surface-light);
        color: white;
        border-bottom-left-radius: 4px;
      }
      .msg-img {
        max-width: 200px;
        border-radius: 12px;
        margin-top: 5px;
        cursor: pointer;
      }
      .msg-time {
        font-size: 10px;
        opacity: 0.6;
        margin-top: 4px;
        display: block;
        text-align: right;
      }
      .input-bar {
        background: var(--surface-color);
        padding: 12px 15px;
        display: flex;
        align-items: flex-end;
        gap: 8px;
        border-top: 1px solid var(--border-color);
      }
      .text-input {
        flex: 1;
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 24px;
        padding: 12px 16px;
        color: white;
        font-size: 15px;
        outline: none;
        resize: none;
        max-height: 120px;
        min-height: 44px;
      }
      .action-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        flex-shrink: 0;
        transition: 0.1s;
      }
      .action-btn:active {
        transform: scale(0.9);
      }
      .btn-icon {
        color: var(--text-secondary);
        background: transparent;
      }
      .btn-send {
        background: var(--primary-color);
        color: white;
      }
      .btn-money {
        background: #fbbf24;
        color: #000;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 200;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: 0.2s;
      }
      .modal-overlay.open {
        display: flex;
        opacity: 1;
      }
      .modal-content {
        background: var(--surface-color);
        width: 90%;
        max-width: 400px;
        border-radius: 24px;
        padding: 25px;
        max-height: 85vh;
        overflow-y: auto;
      }
      .input-field {
        width: 100%;
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        padding: 15px;
        border-radius: 14px;
        color: white;
        margin-bottom: 15px;
        outline: none;
        font-size: 15px;
      }
      .btn-primary {
        width: 100%;
        background: var(--primary-color);
        color: white;
        padding: 15px;
        border: none;
        border-radius: 14px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 10px;
      }
      .profile-card {
        background: var(--surface-light);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        position: relative;
      }
      .wallet-card {
        background: linear-gradient(135deg, #1e293b, #0f172a);
        border-radius: 24px;
        padding: 25px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        text-align: center;
      }
      .wallet-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }
      .wallet-btn {
        flex: 1;
        padding: 12px;
        border-radius: 12px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        font-size: 13px;
      }
      .withdraw-btn {
        background: #ef4444;
        color: white;
      }
      .receive-btn {
        background: #22c55e;
        color: white;
      }
      .toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: var(--surface-light);
        color: white;
        padding: 12px 25px;
        border-radius: 30px;
        border: 1px solid var(--primary-color);
        font-size: 14px;
        opacity: 0;
        transition: 0.3s;
        z-index: 1000;
        pointer-events: none;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      .edit-pencil {
        position: absolute;
        top: 15px;
        right: 15px;
        color: var(--primary-color);
        cursor: pointer;
      }
      .dot-loader {
        display: flex;
        gap: 4px;
        padding: 10px;
      }
      .dot {
        width: 8px;
        height: 8px;
        background: var(--text-secondary);
        border-radius: 50%;
        animation: dot-jump 1.4s infinite ease-in-out;
      }
      .dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes dot-jump {
        0%,
        80%,
        100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-8px);
        }
      }
      .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid var(--border-color);
      }
      .setting-label {
        font-size: 14px;
        font-weight: 500;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 20px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #374151;
        transition: 0.3s;
        border-radius: 20px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 14px;
        width: 14px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: var(--primary-color);
      }
      input:checked + .slider:before {
        transform: translateX(20px);
      }
      
      /* Updated AI Chat Layout Styles */
      #ai-messages {
        display: flex;
        flex-direction: column;
        padding: 15px;
      }
      .ai-message {
        max-width: 85%;
        padding: 12px 18px;
        border-radius: 18px;
        margin-bottom: 12px;
        font-size: 15px;
        line-height: 1.4;
        word-wrap: break-word;
      }
      .ai-message.user {
        align-self: flex-end;
        background: var(--primary-color);
        color: white;
        border-bottom-right-radius: 4px;
      }
      .ai-message.bot {
        align-self: flex-start;
        background: var(--surface-light);
        color: white;
        border-bottom-left-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div id="toast" class="toast"></div>
    <div id="view-chat" class="view-container active">
      <div class="app-header">
        <div class="app-title">Messages</div>
        <button class="action-btn btn-icon" id="btn-new-chat">
          <i class="material-icons-round">add_circle</i>
        </button>
      </div>
      <div id="chat-list" class="scrollable" style="padding-top: 15px"></div>
      <div id="chat-room">
        <div class="chat-room-header">
          <button class="action-btn btn-icon" id="btn-back-chat">
            <i class="material-icons-round">arrow_back_ios</i>
          </button>
          <img
            src=""
            id="curr-chat-avatar"
            class="chat-avatar"
            style="width: 38px; height: 38px; margin-left: 10px"
          />
          <div
            id="curr-chat-name"
            style="margin-left: 12px; font-weight: 600; font-size: 16px"
          ></div>
        </div>
        <div id="messages-area" class="messages-container"></div>
        <div class="input-bar">
          <button class="action-btn btn-money" id="btn-money-modal">
            <i class="material-icons-round">payments</i>
          </button>
          <button class="action-btn btn-icon" id="btn-attach">
            <i class="material-icons-round">add</i>
          </button>
          <input type="file" id="file-input" accept="image/*" class="hidden" />
          <textarea
            id="msg-input"
            class="text-input"
            rows="1"
            placeholder="Type here..."
          ></textarea>
          <button class="action-btn btn-send" id="btn-send-msg">
            <i class="material-icons-round">send</i>
          </button>
        </div>
      </div>
    </div>
    <div id="view-ai" class="view-container">
      <div class="app-header">
        <div class="app-title">Crypa AI</div>
        <button class="action-btn btn-icon" id="btn-ai-clear">
          <i class="material-icons-round">auto_fix_high</i>
        </button>
      </div>
      <div id="ai-messages" class="scrollable"></div>
      <div class="input-bar">
        <textarea
          id="ai-input"
          class="text-input"
          rows="1"
          placeholder="Ask anything..."
        ></textarea>
        <button class="action-btn btn-send" id="btn-ai-send">
          <i class="material-icons-round">bolt</i>
        </button>
      </div>
    </div>
    <div id="view-profile" class="view-container">
      <div class="app-header"><div class="app-title">Account</div></div>
      <div class="scrollable" style="padding: 20px">
        <div class="profile-card">
          <img
            src=""
            id="p-avatar"
            class="chat-avatar"
            style="width: 65px; height: 65px"
          />
          <div>
            <div id="p-username" style="font-size: 18px; font-weight: 700">
              User
            </div>
            <div style="font-size: 12px; color: #22c55e; margin-top: 4px">
              Active Member
            </div>
          </div>
          <i class="material-icons-round edit-pencil" id="btn-edit-p">edit</i>
        </div>
        <div class="wallet-card">
          <div
            style="
              font-size: 11px;
              color: var(--text-secondary);
              text-transform: uppercase;
            "
          >
            Eth Balance
          </div>
          <div
            id="p-wallet-bal"
            style="font-size: 32px; font-weight: 800; margin: 8px 0"
          >
            0.00 ETH
          </div>
          <div
            id="p-wallet-addr"
            style="font-size: 10px; opacity: 0.4; word-break: break-all"
          >
            0x...
          </div>
          <div class="wallet-actions">
            <button class="wallet-btn withdraw-btn" id="p-withdraw">
              <i class="material-icons-round">north_east</i> Withdraw
            </button>
            <button class="wallet-btn receive-btn" id="p-receive">
              <i class="material-icons-round">south_west</i> Receive
            </button>
          </div>
        </div>
        <button
          class="btn-primary"
          style="background: var(--surface-light)"
          id="btn-privacy-modal"
        >
          <i
            class="material-icons-round"
            style="vertical-align: middle; margin-right: 8px"
            >verified_user</i
          >
          Privacy
        </button>
        <button
          class="btn-primary"
          style="background: transparent; border: 1px solid var(--border-color)"
          id="btn-logout"
        >
          Sign Out
        </button>
        <button
          class="btn-primary"
          style="
            background: transparent;
            border: none;
            color: var(--danger-color);
            font-size: 13px;
          "
          id="btn-delete-acc"
        >
          Delete Account
        </button>
      </div>
    </div>
    <div class="bottom-nav">
      <div class="nav-item active" data-target="view-chat">
        <i class="material-icons-round">chat_bubble</i><span>CHATS</span>
      </div>
      <div class="nav-item" data-target="view-ai">
        <i class="material-icons-round">psychology</i><span>AI</span>
      </div>
      <div class="nav-item" data-target="view-profile">
        <i class="material-icons-round">account_circle</i><span>PROFILE</span>
      </div>
    </div>
    <div id="modal-transfer" class="modal-overlay">
      <div class="modal-content">
        <h3>Send Crypto</h3>
        <p
          style="
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 15px;
          "
        >
          Internal transfer to contact
        </p>
        <input
          type="number"
          id="t-amount"
          class="input-field"
          placeholder="Amount ETH"
        />
        <button class="btn-primary" id="btn-do-transfer">Send Now</button>
        <button
          class="btn-primary"
          style="background: transparent"
          onclick="this.closest('.modal-overlay').classList.remove('open')"
        >
          Cancel
        </button>
      </div>
    </div>
    <div id="modal-withdraw" class="modal-overlay">
      <div class="modal-content">
        <h3>On-Chain Withdraw</h3>
        <input
          type="text"
          id="w-addr"
          class="input-field"
          placeholder="0x Recipient Address"
        />
        <input
          type="number"
          id="w-amt"
          class="input-field"
          placeholder="Amount ETH"
        />
        <button class="btn-primary" id="btn-do-withdraw">Broadcast TX</button>
        <button
          class="btn-primary"
          style="background: transparent"
          onclick="this.closest('.modal-overlay').classList.remove('open')"
        >
          Cancel
        </button>
      </div>
    </div>
    <div id="modal-receive" class="modal-overlay">
      <div class="modal-content" style="text-align: center">
        <h3>Your Wallet</h3>
        <div
          id="r-addr"
          style="
            background: var(--bg-color);
            padding: 15px;
            border-radius: 12px;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
            margin: 20px 0;
            border: 1px dashed var(--primary-color);
          "
        ></div>
        <button class="btn-primary" id="btn-copy">Copy Address</button>
        <button
          class="btn-primary"
          style="background: transparent"
          onclick="this.closest('.modal-overlay').classList.remove('open')"
        >
          Done
        </button>
      </div>
    </div>
    <div id="modal-edit-profile" class="modal-overlay">
      <div class="modal-content">
        <h3>Edit Profile</h3>
        <div style="text-align: center; margin-bottom: 20px">
          <img
            src=""
            id="edit-p-preview"
            class="chat-avatar"
            style="
              width: 80px;
              height: 80px;
              margin: 0 auto 10px;
              display: block;
            "
          />
          <button
            class="btn-primary"
            style="font-size: 12px; padding: 8px"
            id="btn-change-avatar"
          >
            Change Photo
          </button>
          <input
            type="file"
            id="avatar-input"
            accept="image/*"
            class="hidden"
          />
        </div>
        <input
          type="text"
          id="edit-p-name"
          class="input-field"
          placeholder="Username"
        />
        <button class="btn-primary" id="btn-save-profile">Save</button>
        <button
          class="btn-primary"
          style="background: transparent"
          onclick="this.closest('.modal-overlay').classList.remove('open')"
        >
          Cancel
        </button>
      </div>
    </div>
    <div id="modal-privacy" class="modal-overlay">
      <div class="modal-content">
        <h3>Privacy & Security</h3>
        <div id="privacy-list"></div>
        <button
          class="btn-primary"
          style="margin-top: 20px"
          onclick="this.closest('.modal-overlay').classList.remove('open')"
        >
          Close
        </button>
      </div>
    </div>
    <div id="modal-new-chat" class="modal-overlay">
      <div class="modal-content">
        <h3>Start Chat</h3>
        <input
          type="text"
          id="search-input"
          class="input-field"
          placeholder="Search username..."
        />
        <div id="search-results"></div>
        <button
          class="btn-primary"
          style="background: transparent; margin-top: 10px"
          onclick="this.closest('.modal-overlay').classList.remove('open')"
        >
          Close
        </button>
      </div>
    </div>
    <div id="modal-confirm" class="modal-overlay">
      <div class="modal-content" style="text-align: center">
        <h3 id="confirm-title">Delete Message?</h3>
        <p
          id="confirm-body"
          style="
            margin: 10px 0 20px;
            font-size: 14px;
            color: var(--text-secondary);
          "
        >
          This action cannot be undone.
        </p>
        <button
          class="btn-primary"
          style="background: var(--danger-color)"
          id="btn-confirm-yes"
        >
          Delete
        </button>
        <button
          class="btn-primary"
          style="background: transparent"
          id="btn-confirm-no"
        >
          Cancel
        </button>
      </div>
    </div>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        onValue,
        push,
        update,
        remove,
        get,
      } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
        deleteUser,
      } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
      const firebaseConfig = {
        apiKey: "AIzaSyAAy3uUW0adMIMfPVRZXZkOHipi3y1v7gs",
        authDomain: "crypa-f60b0.firebaseapp.com",
        databaseURL:
          "https://crypa-f60b0-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "crypa-f60b0",
        storageBucket: "crypa-f60b0.firebasestorage.app",
        messagingSenderId: "504499957380",
        appId: "1:504499957380:web:0dd3cb2e0f9fd15a451cd1",
      };
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth(app);
      const rpc = new ethers.JsonRpcProvider(
        "https://ethereum-rpc.publicnode.com"
      );
      const aiKey = atob(
        "c2stb3ItdjEtZmE0MTcwMTU0NDUyNzgzOGZiOWFkODkwODJlOWQyOTIxYmJlZmU0N2Q2N2IzMjZkY2Q3NDlmMWZiNGYyYjNlOA=="
      );
      let user = null,
        chatId = null,
        otherUid = null,
        wallet = {},
        users = {},
        // Initialize AI History with System Prompt
        aiHistory = [
          {
            role: "system",
            content: "You are Crypa AI, developed by Itumo Longinus ILC company. You are a specialized assistant for the Crypa Pro app. The app has the following features: 1. Encrypted Chat: Users can message friends securely. 2. Crypto Wallet: Users can send ETH internally to friends or withdraw to external addresses. 3. Profile: Users can manage account settings. Rules: Reply with very short and concise messages. Do not use Markdown or HTML tags. Strictly refuse off-topic conversations. Keep your identity as Crypa AI."
          }
        ],
        confirmAction = null;

      function toast(m) {
        const e = document.getElementById("toast");
        e.innerText = m;
        e.classList.add("show");
        setTimeout(() => e.classList.remove("show"), 3000);
      }
      document.querySelectorAll(".nav-item").forEach((n) => {
        n.onclick = () => {
          document
            .querySelectorAll(".nav-item")
            .forEach((i) => i.classList.remove("active"));
          n.classList.add("active");
          document
            .querySelectorAll(".view-container")
            .forEach((v) => v.classList.remove("active"));
          document.getElementById(n.dataset.target).classList.add("active");
        };
      });
      onAuthStateChanged(auth, (u) => {
        if (u) {
          user = u;
          init();
        } else {
          window.location.href = "index.html";
        }
      });
      async function init() {
        onValue(ref(db, `users/${user.uid}`), (s) => {
          if (s.exists()) {
            const d = s.val();
            document.getElementById("p-username").innerText = d.username;
            document.getElementById("p-avatar").src =
              d.avatar || `https://ui-avatars.com/api/?name=${d.username}`;
            document.getElementById("edit-p-name").value = d.username;
            document.getElementById("edit-p-preview").src =
              d.avatar || `https://ui-avatars.com/api/?name=${d.username}`;
          }
        });
        const as = await get(ref(db, "users"));
        if (as.exists()) users = as.val();
        setupWallet();
        loadChats();
        buildPrivacy();
        renderAI(); // Initial render (though it will be empty except for system prompt)
      }
      async function setupWallet() {
        const s = await get(ref(db, `users/${user.uid}/wallets/eth`));
        if (!s.exists()) {
          const w = ethers.Wallet.createRandom();
          wallet = { address: w.address, balance: "0.00" };
          await set(ref(db, `users/${user.uid}/wallets/eth`), wallet);
          localStorage.setItem(`pk_${user.uid}`, w.privateKey);
        } else {
          wallet = s.val();
          const pk = localStorage.getItem(`pk_${user.uid}`);
          try {
            const b = await rpc.getBalance(wallet.address);
            wallet.balance = parseFloat(ethers.formatEther(b)).toFixed(4);
            update(ref(db, `users/${user.uid}/wallets/eth`), {
              balance: wallet.balance,
            });
          } catch (e) {}
        }
        document.getElementById(
          "p-wallet-bal"
        ).innerText = `${wallet.balance} ETH`;
        document.getElementById("p-wallet-addr").innerText = wallet.address;
        document.getElementById("r-addr").innerText = wallet.address;
      }
      function loadChats() {
        onValue(ref(db, `user_chats/${user.uid}`), async (s) => {
          const l = document.getElementById("chat-list");
          l.innerHTML = "";
          const d = s.val();
          if (!d) return;
          for (const id in d) {
            const cs = await get(ref(db, `chats/${id}`));
            if (!cs.exists()) continue;
            const ouid = cs.val().members.find((m) => m !== user.uid);
            const ud =
              users[ouid] || (await get(ref(db, `users/${ouid}`))).val();
            const item = document.createElement("div");
            item.className = "chat-item";
            item.innerHTML = `<img src="${
              ud.avatar || "https://ui-avatars.com/api/?name=" + ud.username
            }" class="chat-avatar"><div class="chat-info"><div class="chat-name">${
              ud.username
            }</div><div class="chat-msg">${d[id].lastMessage}</div></div>`;
            item.onclick = () => openChat(id, ud);
            l.appendChild(item);
          }
        });
      }
      function openChat(id, ud) {
        chatId = id;
        otherUid = ud.uid;
        document.getElementById("chat-room").classList.add("active");
        document.getElementById("curr-chat-name").innerText = ud.username;
        document.getElementById("curr-chat-avatar").src =
          ud.avatar || "https://ui-avatars.com/api/?name=" + ud.username;
        const a = document.getElementById("messages-area");
        onValue(ref(db, `messages/${id}`), (s) => {
          a.innerHTML = "";
          if (!s.exists()) return;
          Object.values(s.val()).forEach((m) => {
            const b = document.createElement("div");
            b.className = `message-bubble ${
              m.sender === user.uid ? "sent" : "received"
            }`;
            let c =
              m.type === "img"
                ? `<img src="${m.text}" class="msg-img" onclick="window.confirmDeleteMsg('${m.key}')">`
                : `<div>${m.text}</div>`;
            b.innerHTML = `${c}<span class="msg-time">${new Date(
              m.time
            ).toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            })}</span>`;
            if (m.sender === user.uid)
              b.onclick = () => window.confirmDeleteMsg(m.key);
            a.appendChild(b);
          });
          a.scrollTop = a.scrollHeight;
        });
      }
      async function sendMsg(txt, type = "text") {
        if (!txt || !chatId) return;
        const mRef = push(ref(db, `messages/${chatId}`));
        const key = mRef.key;
        await set(mRef, {
          sender: user.uid,
          text: txt,
          type,
          time: Date.now(),
          key,
        });
        const upd = {
          lastMessage: type === "img" ? "Photo" : txt,
          timestamp: Date.now(),
        };
        update(ref(db, `user_chats/${user.uid}/${chatId}`), upd);
        update(ref(db, `user_chats/${otherUid}/${chatId}`), upd);
      }
      document.getElementById("btn-send-msg").onclick = () => {
        const i = document.getElementById("msg-input");
        const t = i.value.trim();
        sendMsg(t);
        i.value = "";
      };
      document.getElementById("btn-attach").onclick = () =>
        document.getElementById("file-input").click();
      document.getElementById("file-input").onchange = (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = (ev) => {
          const img = new Image();
          img.src = ev.target.result;
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const max = 400;
            let w = img.width,
              h = img.height;
            if (w > h) {
              if (w > max) {
                h *= max / w;
                w = max;
              }
            } else {
              if (h > max) {
                w *= max / h;
                h = max;
              }
            }
            canvas.width = w;
            canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);
            sendMsg(canvas.toDataURL("image/jpeg", 0.7), "img");
          };
        };
        r.readAsDataURL(f);
      };
      window.confirmDeleteMsg = (mKey) => {
        document.getElementById("modal-confirm").classList.add("open");
        confirmAction = () => {
          remove(ref(db, `messages/${chatId}/${mKey}`));
          document.getElementById("modal-confirm").classList.remove("open");
        };
      };
      document.getElementById("btn-confirm-yes").onclick = () =>
        confirmAction();
      document.getElementById("btn-confirm-no").onclick = () =>
        document.getElementById("modal-confirm").classList.remove("open");
      document.getElementById("btn-money-modal").onclick = () =>
        document.getElementById("modal-transfer").classList.add("open");
      document.getElementById("btn-do-transfer").onclick = async () => {
        const a = parseFloat(document.getElementById("t-amount").value);
        if (!a || a > parseFloat(wallet.balance))
          return toast("Insufficient Balance");
        const newSenderB = (parseFloat(wallet.balance) - a).toFixed(4);
        await update(ref(db, `users/${user.uid}/wallets/eth`), {
          balance: newSenderB,
        });
        const rSnap = await get(ref(db, `users/${otherUid}/wallets/eth`));
        const newRecB = (parseFloat(rSnap.val()?.balance || 0) + a).toFixed(4);
        await update(ref(db, `users/${otherUid}/wallets/eth`), {
          balance: newRecB,
        });
        sendMsg(`ðŸ’¸ Sent ${a} ETH`);
        document.getElementById("modal-transfer").classList.remove("open");
        setupWallet();
      };
      document.getElementById("btn-ai-send").onclick = async () => {
        const i = document.getElementById("ai-input");
        const t = i.value.trim();
        if (!t) return;
        aiHistory.push({ role: "user", content: t });
        renderAI();
        i.value = "";
        const l = document.createElement("div");
        l.className = "ai-message bot";
        l.id = "ai-loader";
        l.innerHTML =
          '<div class="dot-loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
        document.getElementById("ai-messages").appendChild(l);
        document.getElementById("ai-messages").scrollTop =
          document.getElementById("ai-messages").scrollHeight;
        try {
          const r = await fetch(
            "https://openrouter.ai/api/v1/chat/completions",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${aiKey}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                model: "mistralai/mistral-7b-instruct:free",
                messages: aiHistory,
              }),
            }
          );
          const d = await r.json();
          document.getElementById("ai-loader").remove();
          
          // Sanitize content: Remove HTML tags (like <s>, </s>) and markdown
          let rawContent = d.choices[0].message.content;
          let cleanContent = rawContent.replace(/<[^>]*>?/gm, '').replace(/\*\*/g, '');
          
          aiHistory.push({ role: "assistant", content: cleanContent });
          renderAI();
        } catch (e) {
          document.getElementById("ai-loader").remove();
          toast("AI Busy");
        }
      };
      function renderAI() {
        const a = document.getElementById("ai-messages");
        a.innerHTML = "";
        aiHistory.forEach((m) => {
          // Don't render the system prompt to the user
          if (m.role === "system") return;

          const d = document.createElement("div");
          d.className = `ai-message ${m.role === "user" ? "user" : "bot"}`;
          d.innerText = m.content; // Use innerText to ensure plain text
          a.appendChild(d);
        });
        a.scrollTop = a.scrollHeight;
      }
      document.getElementById("p-withdraw").onclick = () =>
        document.getElementById("modal-withdraw").classList.add("open");
      document.getElementById("p-receive").onclick = () =>
        document.getElementById("modal-receive").classList.add("open");
      document.getElementById("btn-copy").onclick = () => {
        navigator.clipboard.writeText(wallet.address);
        toast("Copied");
      };
      document.getElementById("btn-do-withdraw").onclick = () => {
        const a = document.getElementById("w-addr").value;
        if (!ethers.isAddress(a)) return toast("Invalid Address");
        toast("Broadcasting...");
        document.getElementById("modal-withdraw").classList.remove("open");
        setTimeout(() => toast("Failed: No Gas"), 2000);
      };
      document.getElementById("btn-edit-p").onclick = () =>
        document.getElementById("modal-edit-profile").classList.add("open");
      document.getElementById("btn-change-avatar").onclick = () =>
        document.getElementById("avatar-input").click();
      document.getElementById("avatar-input").onchange = (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = (ev) =>
          (document.getElementById("edit-p-preview").src = ev.target.result);
        r.readAsDataURL(f);
      };
      document.getElementById("btn-save-profile").onclick = async () => {
        const n = document.getElementById("edit-p-name").value;
        const av = document.getElementById("edit-p-preview").src;
        await update(ref(db, `users/${user.uid}`), { username: n, avatar: av });
        document.getElementById("modal-edit-profile").classList.remove("open");
        toast("Updated");
      };
      document.getElementById("btn-logout").onclick = () => signOut(auth);
      document.getElementById("btn-delete-acc").onclick = async () => {
        if (confirm("Delete everything?")) {
          await remove(ref(db, `users/${user.uid}`));
          await deleteUser(auth.currentUser);
        }
      };
      document.getElementById("btn-privacy-modal").onclick = () =>
        document.getElementById("modal-privacy").classList.add("open");
      document.getElementById("btn-back-chat").onclick = () =>
        document.getElementById("chat-room").classList.remove("active");
      document.getElementById("btn-new-chat").onclick = () => {
        document.getElementById("modal-new-chat").classList.add("open");
        document.getElementById("search-results").innerHTML = "";
      };
      document.getElementById("search-input").oninput = (e) => {
        const v = e.target.value.toLowerCase();
        const r = document.getElementById("search-results");
        r.innerHTML = "";
        if (v.length < 2) return;
        Object.keys(users).forEach((uid) => {
          if (
            users[uid].username.toLowerCase().includes(v) &&
            uid !== user.uid
          ) {
            const d = document.createElement("div");
            d.className = "chat-item";
            d.style.margin = "5px 0";
            d.innerHTML = `<img src="${
              users[uid].avatar ||
              "https://ui-avatars.com/api/?name=" + users[uid].username
            }" class="chat-avatar" style="width:35px;height:35px"><div>${
              users[uid].username
            }</div>`;
            d.onclick = () => {
              const cid = [user.uid, uid].sort().join("_");
              set(ref(db, `chats/${cid}`), {
                members: [user.uid, uid],
                timestamp: Date.now(),
              });
              document
                .getElementById("modal-new-chat")
                .classList.remove("open");
              openChat(cid, users[uid]);
            };
            r.appendChild(d);
          }
        });
      };
      function buildPrivacy() {
        const l = document.getElementById("privacy-list");
        const s = [
          "Read Receipts",
          "Online Status",
          "2FA Security",
          "Wallet Privacy",
          "Incognito Mode",
          "Biometric Lock",
        ];
        s.forEach((t) => {
          const i = document.createElement("div");
          i.className = "setting-item";
          i.innerHTML = `<span class="setting-label">${t}</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label>`;
          l.appendChild(i);
        });
      }
    </script>
  </body>
</html>
